name: Deploy Backend

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      
      - name: Create Firebase Service Account File
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}" | base64 -d > src/main/resources/firebase-service-account.json

      - name: Build JAR
        run: |
          # UPDATED: Removed "cd backend" since pom.xml is in the root
          mvn clean package -DskipTests

      - name: Copy to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.jar"        # UPDATED: Removed "backend/" prefix
          target: "/home/ubuntu/app"
          strip_components: 1           # UPDATED: Changed to 1 to strip just "target/"

      - name: Set Environment Variables on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: GOOGLE_MAPS_API_KEY
          script: |
            ENV_FILE="/home/ubuntu/app/.env"
            # Add GOOGLE_MAPS_API_KEY if not present, or update if exists
            if grep -q "^GOOGLE_MAPS_API_KEY=" "$ENV_FILE" 2>/dev/null; then
              sed -i "s|^GOOGLE_MAPS_API_KEY=.*|GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}|" "$ENV_FILE"
            else
              echo "GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}" >> "$ENV_FILE"
            fi
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl restart ocpp.service